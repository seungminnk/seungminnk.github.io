---
title: Cloud SQL Proxy로 비공개 DB 접속하기
date: 2023-03-29 12:06:00 +0900
categories: [Google Cloud Platform]
tags: [devops, gcp, cloudsqlproxy, cloudsql, mysql, cloudbuild]
---

## 들어가기 전 💬
현재 회사에서 두 서비스의 API 통합 작업을 진행하고 있는데, 통합 과정에서 몇 가지 문제점이 발생했다. 이 문제들을 해결하기 위해서 어떤 방법을 사용했고, 어떻게 해결했는지를 정리해보고자 한다 🤓
<br><br>

먼저 현재 두 서비스가 어떤 구조로 구성되어 있는지 간단히 설명하자면 다음과 같다.
- A 서비스는 **Proj-A**에 모든 인프라가 위치해있다.
    - **Api-A** : A 서비스의 API, **GKE**로 운영 중이다.
    - **Db-A** : Api-A와 연결되어 있는 데이터베이스, Cloud SQL로 운영 중이다.
- B 서비스는 **Proj-B**에 모든 인프라가 위치해있다.
    - **Api-B** : B 서비스의 API, **GCE 인스턴스**로 운영 중이다.
    - **Db-B** : Api-B와 연결되어 있는 데이터베이스, Cloud SQL로 운영 중이다.
- **Api-A에 Api-B를 통합**하는 작업을 진행하려한다.

즉 정리하자면, 두 시스템이 **서로 다른 GCP 프로젝트에 각각 구성**되어 있어 **각 프로젝트의 리소스끼리의 접근에 제한이 있다**는 것이다.

이로 인해 다음과 같은 문제가 발생하였고, 이를 해결하기 위한 해결책이 필요한 상황이었다.
1. Proj-A의 Api-A에서 Proj-B의 Db-B에 접근할 수 없다. <br>
    _(다른 GCP 프로젝트끼리는 별도의 VPC로 구성되어 있으므로, 다른 프로젝트 리소스에 접근하기 위해서는 별도의 네트워크 설정이 필요하다.)_
2. Api-A에서 두 개의 데이터베이스 _(Db-A & Db-B)_ 로 동시에 JDBC Datasource 연결을 물고 있어야 한다.

### 본격적인 문제 해결 전, 마주친 또 다른 문제 상황 😭
위에서 언급했던 문제 상황을 본격적으로 해결하기 전에 Db-A를 살펴보다가 또 다른 문제 상황을 직면했다.

현재 Api-A에서는 빌드 시에 테스트 코드가 실행된다. 이 때 Db-A의 테스트 실행용 스키마에 접근하기 위해 Db-A의 외부 IP로 접근하는데, Db-A에 모든 IP를 허용(0.0.0.0/0)하도록 설정되어 있었다! 😨
모든 IP를 허용하는 것은 보안상 위험하다고 판단하여 해당 설정을 제거했는데, 이로 인해 테스트 코드가 실행될 때 Db-A에 접속할 수 없어 빌드 실패가 발생하였다.

Api-A의 빌드와 배포는 Cloud Build를 이용하는데, 이 문제로 빌드 실패가 발생해 배포까지 이루어지지 못했고, 때문에 이 이슈를 먼저 해결한 후 앞서 언급했던 문제들을 해결하고자 했다.

### gradle test 성공을 위한 시도 방법들
그래서 gradle test 성공을 위해 다음과 같이 여러 방법을 시도해보았다.<br><br>


**1. Cloud Build 서비스 계정에 SQL 권한 부여하기**

처음에는 가장 먼저 접근 권한을 의심해보았다. 

같은 GCP 프로젝트 내에서는 기본적으로 모든 리소스가 같은 네트워크 상에 존재하기 때문에, 별도 네트워크 설정 없이 접근이 가능하다.

그래서 Cloud Build와 Db-A는 같은 Proj-A에 있어 각 리소스들끼리는 접근이 가능한데, Cloud Build의 서비스 계정이 SQL에 접근할 수 있는 권한이 없어 Db-A에 접속하지 못하는 것이라고 생각했다. 

GCP 콘솔 > IAM > 서비스 계정 메뉴에 접속하여 Cloud Build의 서비스 계정에 **SQL 클라이언트** 권한을 부여해주고, 다시 Cloud Build를 실행하여 빌드를 시도해보았다.

하지만 SQL 권한을 부여해주어도 여전히 Db-A에 접근할 수 없었다.
<br><br>

**2. Cloud Build의 IP 알아내기**

권한 문제는 아니고, 그렇다면 그 다음은 네트워크 문제를 의심해보았다.

Cloud Build에서 gradle test가 실행될 때 Db-A로의 접근이 불가능한 상황이니, Cloud Build가 실행되는 곳의 IP가 Db-A에 허용되지 않아 접속하지 못하는 것일 수 있겠다는 생각이 들었다.

그래서 Cloud Build에 ifconfig 명령어를 실행하여 출력하는 step을 추가하여 IP 주소를 알아내고, 그 IP 주소를 Db-A에 허용 IP로 추가해주었다.

하지만 이 방법도 실패했다 😥 Cloud Build는 **실행될 때마다 IP 주소가 변경**되었고, 이전 빌드에서 IP 주소를 알아내 Db-A에 설정해주어도 새로 빌드를 실행할 때는 다른 IP 주소를 가지고 실행되었기 때문에 이 방법으로는 해결할 수 없었다.
<br><br>

**3. Cloud Build의 IP 대역 알아내기**

<br><br>

**4. Cloud SQL Proxy 이용하기 ⭐️**

<br><br>


## Cloud SQL Proxy? 🤔


## Cloud Build에서 비공개 DB에 접근하기

### cloudbuild.yml 수정

### jdbc datasource 설정 변경

### Cloud Build 다시 실행해보기

### cloudbuild.yml 최종 수정 및 빌드 성공 확인! ✌️



## 다른 GCP 프로젝트의 DB에 접근하기

### Cloud SQL Proxy 설치 및 실행

### Cloud SQL Proxy를 통한 DB 접속

### GKE 배포 확인
